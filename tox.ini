[tox]
envlist = py{3.6,3.7,3.8,nightly}-django2.2,py{3.6,3.7,3.8,3.9,3.10,nightly}-django{3.2,4.0,master},lint,docs,functional

[testenv]
passenv = *
setenv =
    PYTHONDONTWRITEBYTECODE=1
basepython =
    py3.6: python3.6
    py3.7: python3.7
    py3.8: python3.8
    py3.9: python3.9
    py3.10: python3.10
    pypypy: pypy
    pypypy3: pypy3
    pynightly: python
deps =
    -rrequirements-tests.txt
    django2.2: Django>=2.2,<2.3
    django3.2: Django>=3.2,<3.3
    django4.0: Django>=4.0,<4.1
    djangomaster: https://github.com/django/django/archive/master.zip
commands = {posargs:coverage run runtests.py}

# Configure which test environments are run for each Github Actions Python version.
[gh-actions]
python =
    3.6: py36-django{22,32}
    3.7: py37-django{22,32}
    3.8: py38-django{22,32,40}
    3.9: py39-django{22,32,40}
    3.10: py310-django{22,32,40}

[testenv:lint]
basepython = python
deps =
    prospector
commands = prospector dbbackup -0

[testenv:docs]
basepython = python
whitelist_externals=make
deps = -rrequirements-docs.txt
commands = make docs

[testenv:functional]
basepython = python
passenv = *
whitelist_externals = bash
deps =
    -rrequirements-tests.txt
    Django
    mysqlclient
    psycopg2
commands = {posargs:bash -x functional.sh}


[testenv:functional-mongodb]
basepython = python
passenv = *
whitelist_externals = bash
deps =
    -rrequirements-tests.txt
    djongo
commands = {posargs:bash -x functional.sh}

[testenv:build]
basepython = python
skip_install = true
deps =
    build
commands =
    {envpython} -m build

[testenv:upload]
basepython = python
skip_install = true
deps =
    twine
commands =
    {envpython} -m twine upload {toxinidir}/dist/*
